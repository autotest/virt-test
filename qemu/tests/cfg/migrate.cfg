- migrate: install setup image_copy unattended_install.cdrom
    type = migration
    migration_test_command = help
    migration_bg_command = "cd /tmp; nohup tcpdump -q -i any -t ip host localhost"
    migration_bg_check_command = pgrep tcpdump
    migration_bg_kill_command = pkill tcpdump
    kill_vm_on_error = yes
    iterations = 2
    used_mem = 1024
    mig_timeout = 3600
    # you can uncomment the following line to enable the state
    # check
    # vmstate_check = yes
    variants:
        - tcp:
            migration_protocol = "tcp"
        - unix:
            migration_protocol = "unix"
        - exec:
            migration_protocol = "exec"
        - fd:
            migration_protocol = "fd"
        - mig_cancel:
            migration_protocol = "tcp"
            mig_cancel = yes
            only migrate..default
    variants:
        - @default:
        - with_speed_measurement:
            no JeOS
            # migration speed in bytes. Default scaler is M (350 == 350M)
            only Linux
            mig_speed = 125M
            # accuracy of mig_speed
            # speed_range = (mig_speed+-(mig_speed*mig_speed_accuracy))
            # if real_mig_speed is on in speed_range it raises Test warning.
            mig_speed_accuracy = 0.3
            pre_migrate = "set_speed_and_install"
            type = migration_with_speed_measurement
            exec:
                # Exec migration is pretty slow compared to other protos
                mig_speed = 50M
        - with_set_speed:
            mig_speed = 1G
            pre_migrate = "mig_set_speed"
        - with_reboot:
            iterations = 1
            type = migration_with_reboot
        - with_file_transfer:
            no JeOS
            iterations = 1
            type = migration_with_file_transfer
        - with_autotest:
            no JeOS
            only Linux
            type = autotest_control
            migrate_background = yes
            test_timeout = 1800
            variants:
                - dbench:
                    test_control_file = dbench.control
                - stress:
                    test_control_file = stress.control
                - monotonic_time:
                    test_control_file = monotonic_time.control

- @multi_host:
    remove_image_on_check_error = yes
    force_image_clone = no
    virt_test_type = kvm
    no JeOS
    variants:
        - migrate_multi_host: install setup image_copy unattended_install.cdrom
            type = migration_multi_host
            vms = "vm1"
            start_vm = no
            migration_test_command = help
            migration_bg_command = "cd /tmp; nohup tcpdump -q -i any -t ip host localhost"
            migration_bg_check_command = pgrep tcpdump
            migration_bg_kill_command = pkill tcpdump
            kill_vm_on_error = yes
            iterations = 2
            used_mem = 1024
            mig_timeout = 480
            disk_prepare_timeout = 360
            comm_port = 13234
            regain_ip_cmd = killall dhclient; sleep 10; dhclient;
            variants:
                #Migration protocol.
                -tcp:
                    mig_protocol = "tcp"
                -fd:
                    mig_protocol = "fd"

            variants:
                #Time when start migration
                - after_login_vm:
                    paused_after_start_vm = no
                - early_boot_vm:
                    no measure_migration_speed
                    login_timeout = 420
                    paused_after_start_vm = yes
                    variants:
                        -timeout_0:
                            start_migration_timeout = 0
                        -timeout_6:
                            start_migration_timeout = 6

            variants:
                # Migration properties
                - @default:
                    type = migration_multi_host
                - cancel_with_delay:
                    type = migration_multi_host_cancel
                    only after_login_vm
                    cancel_delay = 10
                - measure_speed:
                    only Linux
                    only after_login_vm
                    not_wait_for_migration = yes
                    mig_speed = 1G
                    type = migration_multi_host_with_speed_measurement
                - with_file_transfer:
                    only Linux
                    only after_login_vm
                    type = migration_multi_host_with_file_transfer
                    comm_port = 13234
                    #path where file is stored on guest.
                    guest_path = "/tmp/file"
                    #size of generated file in MB.
                    file_size = 512
                    transfer_timeout = 440
                    #Transfer speed in Mb
                    transfer_speed = 300
                    #Count of migration during file transfer.
                    migrate_count = 3
                - downtime:
                    only after_login_vm
                    sub_type = downtime
                    # downtime in seconds.
                    max_downtime = 10
                    not_wait_for_migration = yes
                    type = migration_multi_host_downtime_and_speed
                - speed:
                    only after_login_vm
                    sub_type = speed
                    # speed in Mb
                    min_migration_speed = 10M
                    max_migration_speed = 500M
                    # time interval in seconds.
                    # set how fast is migration speed changed.
                    change_speed_interval = 1
                    # speed is changed x time per min max interval
                    count_of_change = 10
                    not_wait_for_migration = yes
                    type = migration_multi_host_downtime_and_speed
                - ping-pong-stress:
                    # amount of memory used for migration stress
                    # amount of memory shouldn't be too high otherwise
                    # migration will never end
                    only after_login_vm
                    type = migration_multi_host_ping_pong
                    # stress_memory should be less than troughput of
                    # migration
                    stress_memory = 50
                    migrate_count = 3
                    migration_timeout = 240
                    variants:
                        - @no_stress:
                            stress_type = none
                        - cpu_memory:
                            stress_type = cpu_memory
                        - disk:
                            disk_usage = 200
                            stress_type = disk
                        - all:
                            stress_type = all

        - cpuflags_multi_host:
            type = cpuflags
            test_type = test_multi_host_migration
            vms = "vm1"
            start_vm = no
            #Try to start guest with all flags which are supported by host.
            all_host_supported_flags = "no"
            cpu_model = "core2duo:sse3"
            guest_spec_flags = "fxsr_opt hypervisor ds pdpe1gb osxsave svm"
            host_spec_flags = "pbe tm ds_cpl monitor acpi dtes64 ht tm2 xtpr est pdcm smx"
            mig_timeout = 4800
            kill_vm_on_error = yes
            disk_prepare_timeout = 360
            comm_port = 13234
            regain_ip_cmd = killall dhclient; sleep 10; dhclient;
            auto_cpu_model = no

    only default_machine_types
    # For RHEL machine type.
    #only rhel_machine_types

    variants:
        - @default_machine_types:
            variants:
                -@pc:
                    machine_type = "pc"
                -pc-0.14:
                    machine_type = "pc-0.14"
                -pc-0.13:
                    machine_type = "pc-0.13"
                -pc-0.12:
                    machine_type = "pc-0.12"
                -pc-0.11:
                    machine_type = "pc-0.11"
                -pc-0.10:
                    machine_type = "pc-0.10"
                -isapc:
                    machine_type = "isapc"

        - @rhel_machine_types:
            variants:
                -@pc:
                    machine_type = "pc"
                - rhel5.4.0:
                    machine_type = "rhel5.4.0"
                - rhel5.4.4:
                    machine_type = "rhel5.4.4"
                - rhel5.5.0:
                    machine_type = "rhel5.5.0"
                - rhel6.0.0:
                    machine_type = "rhel6.0.0"
                - rhel6.2.0:
                    machine_type = "rhel6.2.0"
                - rhel6.3.0:
                    machine_type = "rhel6.3.0"
